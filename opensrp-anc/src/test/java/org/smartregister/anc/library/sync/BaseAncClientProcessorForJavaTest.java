package org.smartregister.anc.library.sync;

import android.content.ContentValues;

import net.sqlcipher.database.SQLiteDatabase;

import org.jetbrains.annotations.NotNull;
import org.joda.time.DateTime;
import org.junit.Assert;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.ArgumentMatchers;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.MockitoAnnotations;
import org.powermock.api.mockito.PowerMockito;
import org.powermock.core.classloader.annotations.PrepareForTest;
import org.powermock.modules.junit4.PowerMockRunner;
import org.robolectric.RuntimeEnvironment;
import org.smartregister.CoreLibrary;
import org.smartregister.anc.library.activity.BaseUnitTest;
import org.smartregister.anc.library.repository.ContactTasksRepository;
import org.smartregister.anc.library.util.ConstantsUtils;
import org.smartregister.domain.Client;
import org.smartregister.domain.Event;
import org.smartregister.domain.db.EventClient;
import org.smartregister.repository.DetailsRepository;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RunWith(PowerMockRunner.class)
@PrepareForTest({CoreLibrary.class})
public class BaseAncClientProcessorForJavaTest extends BaseUnitTest {
    private BaseAncClientProcessorForJava baseAncClientProcessorForJava;

    @Mock
    private SQLiteDatabase sqLiteDatabase;

    @Before
    public void setUp() {
        MockitoAnnotations.initMocks(this);
        baseAncClientProcessorForJava = new BaseAncClientProcessorForJava(RuntimeEnvironment.systemContext);
    }

    @Test
    public void canProcessShouldReturnTrueWhenProvidedAncEventTypes() {
        Assert.assertTrue(baseAncClientProcessorForJava.canProcess(ConstantsUtils.EventTypeUtils.REGISTRATION));
        Assert.assertTrue(baseAncClientProcessorForJava.canProcess(ConstantsUtils.EventTypeUtils.UPDATE_REGISTRATION));
        Assert.assertTrue(baseAncClientProcessorForJava.canProcess(ConstantsUtils.EventTypeUtils.QUICK_CHECK));
        Assert.assertTrue(baseAncClientProcessorForJava.canProcess(ConstantsUtils.EventTypeUtils.CONTACT_VISIT));
        Assert.assertTrue(baseAncClientProcessorForJava.canProcess(ConstantsUtils.EventTypeUtils.CLOSE));
        Assert.assertTrue(baseAncClientProcessorForJava.canProcess(ConstantsUtils.EventTypeUtils.SITE_CHARACTERISTICS));
    }

    @Test
    public void setBaseAncClientProcessorForJava() {
        Assert.assertNotNull(baseAncClientProcessorForJava);
    }

    @Test
    public void getEventTypesShouldReturn6EvenTypes() {
        Assert.assertEquals(6, baseAncClientProcessorForJava.getEventTypes().size());
    }

    @Test
    public void testProcessClientWithEmptyEventList() throws Exception {
        List<EventClient> eventClients = new ArrayList<>();

        BaseAncClientProcessorForJava baseAncClientProcessorForJavaSpy = Mockito.spy(baseAncClientProcessorForJava);
        Assert.assertNotNull(baseAncClientProcessorForJavaSpy);

        baseAncClientProcessorForJavaSpy.processClient(eventClients);
        Mockito.verify(baseAncClientProcessorForJavaSpy, Mockito.times(0)).getDetailsRepository();
    }

    @Test
    public void testProcessClient() throws Exception {
        CoreLibrary coreLibrary = PowerMockito.mock(CoreLibrary.class);
        PowerMockito.mockStatic(CoreLibrary.class);
        PowerMockito.when(CoreLibrary.getInstance()).thenReturn(coreLibrary);
        Assert.assertNotNull(coreLibrary);

        List<EventClient> eventClients = new ArrayList<>();
        Map<String, String> details = getDetailsMap();
        Event event = getEvent(details);
        Client client = getClient();

        EventClient eventClient = new EventClient(event, client);
        eventClients.add(eventClient);

        BaseAncClientProcessorForJava baseAncClientProcessorForJavaSpy = Mockito.spy(baseAncClientProcessorForJava);
        Assert.assertNotNull(baseAncClientProcessorForJavaSpy);

        DetailsRepository detailsRepositorySpy = Mockito.spy(DetailsRepository.class);
        Assert.assertNotNull(detailsRepositorySpy);

        ContactTasksRepository contactTasksRepositorySpy = Mockito.spy(ContactTasksRepository.class);
        Assert.assertNotNull(contactTasksRepositorySpy);

        Mockito.doReturn(detailsRepositorySpy).when(baseAncClientProcessorForJavaSpy).getDetailsRepository();
        Mockito.doNothing().when(detailsRepositorySpy).add(ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.anyLong());

        Mockito.doReturn(new HashMap<>()).when(baseAncClientProcessorForJavaSpy).getPreviousContactMap(ArgumentMatchers.anyString());

        Mockito.doReturn(contactTasksRepositorySpy).when(baseAncClientProcessorForJavaSpy).getContactTasksRepository();
        Mockito.doReturn(true).when(contactTasksRepositorySpy).saveOrUpdateTasks(null);

        Mockito.doReturn(sqLiteDatabase).when(contactTasksRepositorySpy).getWritableDatabase();
        Mockito.doReturn(sqLiteDatabase).when(contactTasksRepositorySpy).getReadableDatabase();
        Mockito.doReturn((long) 3).when(sqLiteDatabase).insert(ArgumentMatchers.anyString(), ArgumentMatchers.anyString(), ArgumentMatchers.eq(new ContentValues()));

        baseAncClientProcessorForJavaSpy.processClient(eventClients);

        Mockito.verify(baseAncClientProcessorForJavaSpy, Mockito.times(1)).getDetailsRepository();
        Mockito.verify(baseAncClientProcessorForJavaSpy, Mockito.times(7)).getContactTasksRepository();
        Mockito.verify(contactTasksRepositorySpy, Mockito.times(7)).getWritableDatabase();
    }

    @NotNull
    private Map<String, String> getDetailsMap() {
        Map<String, String> details = new HashMap<>();
        details.put("Contact", "Contact 2");
        details.put("attention_flag_facts", "{\"pregest_weight_unknown\":\"[pregest_weight_unknown]\",\"condom_use_value\":\"No\",\"severe_preeclampsia\":\"0\",\"occupation\":\"[informal_employment_sex_worker]\",\"isRelevant\":false,\"flu_immun_status\":\"seasonal_flu_dose_given\",\"lmp_edd\":\"0\",\"fetal_heartbeat_value\":\"Yes\",\"select_gest_age_edd\":\"sfh\",\"condom_use\":\"no\",\"medications\":\"[aspirin, calcium, asthma]\",\"blood_type_test_date_today_hidden\":\"27-09-2019\",\"danger_signs\":\"[danger_none]\",\"medications_value\":\"Aspirin, Calcium, Asthma\",\"height\":\"125\",\"tobacco_user_value\":\"No\",\"shs_exposure\":\"yes\",\"cant_record_bp_reason\":\"[bp_cuff_unavailable]\",\"preeclampsia\":\"0\",\"severe_hypertension\":\"0\",\"caffeine_counsel_value\":\"Done\",\"lmp_known_value\":\"No\",\"pulse_rate_repeat\":\"114\",\"toaster26_hidden\":\"0\",\"blood_type_test_date\":\"27-09-2019\",\"weight_gain\":\"0\",\"other_symptoms_value\":\"Gets tired easily, Headache, Vaginal discharge, Visual disturbance\",\"health_conditions_value\":\"Hypertension\",\"danger_signs_value\":\"None\",\"gest_age\":\"25\",\"ultrasound_ga_hidden\":\"0\",\"select_gest_age_edd_value\":\"Using SFH or abdominal palpation\",\"stillbirths\":\"1\",\"cant_record_bp_reason_value\":\"BP cuff (sphygmomanometer) not available\",\"health_conditions\":\"[hypertension]\",\"ultrasound_done_value\":\"No\",\"tobacco_user\":\"no\",\"exp_weight_gain\":\"5 - 9\",\"pulse_rate\":\"125\",\"tt_immun_status\":\"1-4_doses\",\"ipv_enquiry_results_value\":\"Treated\",\"weight_gain_duration\":\"0\",\"no_of_fetuses_unknown_value\":\"No. of fetuses unknown\",\"pallor_value\":\"Yes\",\"sfh_gest_age\":\"25\",\"caffeine_intake\":\"[more_than_3_cups_300ml_of_instant_coffee, more_than_48_pieces_squares_of_chocolate]\",\"flu_immun_status_value\":\"Seasonal flu dose given\",\"partner_hiv_status_value\":\"Dont know\",\"no_of_fetuses_unknown\":\"[no_of_fetuses_unknown]\",\"alcohol_substance_counsel\":\"done\",\"alcohol_substance_counsel_value\":\"Done\",\"phys_symptoms_value\":\"None\",\"pallor\":\"yes\",\"pelvic_exam\":\"2\",\"bmi\":\"35.84\",\"blood_type_test_status\":\"done_today\",\"ultrasound_edd\":\"0\",\"gest_age_openmrs\":\"25\",\"allergies_value\":\"Aluminium hydroxide\",\"gdm_risk\":\"1\",\"lmp_known_date\":\"\",\"hiv_risk\":\"1\",\"miscarriages_abortions\":\"2\",\"rh_factor\":\"positive\",\"ipv_enquiry_value\":\"Done\",\"helper\":null,\"ultrasound_done_date\":\"\",\"pelvic_exam_value\":\"Normal\",\"blood_type_test_status_value\":\"Done today\",\"alcohol_substance_enquiry_value\":\"Yes\",\"edd\":\"10-01-2020\",\"phys_symptoms\":\"[none]\",\"marital_status_value\":\"Never married and never lived together (single)\",\"respiratory_exam\":\"2\",\"weight_cat\":\"Obese\",\"hiv_positive\":\"0\",\"cant_record_bp_value\":\"Unable to record BP\",\"occupation_value\":\"Informal employment (sex worker)\",\"fetal_heartbeat\":\"yes\",\"shs_exposure_value\":\"Yes\",\"hepb_immun_status_value\":\"Not received\",\"ipv_enquiry\":\"done\",\"ipv_enquiry_results\":\"treated\",\"first_weight\":\"56\",\"sfh_edd\":\"10-01-2020\",\"tt_immun_status_value\":\"1-4 doses of TTCV in the past\",\"tot_weight_gain\":\"0\",\"current_weight\":\"56\",\"lmp_gest_age\":\"0\",\"lmp_known\":\"no\",\"allergies\":\"[aluminium_hydroxide]\",\"preeclampsia_risk\":\"1\",\"partner_hiv_positive\":\"0\",\"alcohol_substance_use\":\"[cocaine]\",\"alcohol_substance_use_value\":\"Cocaine \\/ Crack\",\"parity\":\"3\",\"c_sections\":\"1\",\"partner_hiv_status\":\"dont_know\",\"contact_reason\":\"scheduled_contact\",\"ultrasound_gest_age_concept\":\"0\",\"educ_level_value\":\"Higher\",\"rh_factor_value\":\"Positive\",\"ultrasound_done\":\"no\",\"educ_level\":\"higher\",\"blood_type\":\"a\",\"caffeine_counsel\":\"done\",\"other_symptoms\":\"[easily_tired, headache, vaginal_discharge, visual_disturbance]\",\"anaemic\":\"1\",\"sfh_ga_hidden\":\"25 weeks\",\"live_births\":\"2\",\"hepb_immun_status\":\"not_received\",\"contact_reason_value\":\"Scheduled contact\",\"ultrasound_gest_age\":\"0\",\"prev_preg_comps_value\":\"Gestational Diabetes\",\"caffeine_intake_value\":\"More than 3 cups (300 ml) of instant coffee, More than 48 pieces (squares) of chocolate\",\"fetal_heart_rate\":\"125\",\"pregest_weight_unknown_value\":\"Pre-gestational weight unknown\",\"marital_status\":\"single\",\"previous_pregnancies\":\"6\",\"alcohol_substance_enquiry\":\"yes\",\"blood_type_value\":\"A\",\"cant_record_bp\":\"[cant_record_bp]\",\"last_live_birth_preterm\":\"no\",\"hypertension\":\"0\",\"gravida\":\"7\",\"prev_preg_comps\":\"[gestational_diabetes]\",\"body_temp\":\"36\",\"respiratory_exam_value\":\"Normal\",\"last_live_birth_preterm_value\":\"No\"}");
        details.put("previous_contacts", "{\"contact_date\":\"2019-09-27\",\"attention_flag_facts\":\"{\\\"pregest_weight_unknown\\\":\\\"[pregest_weight_unknown]\\\",\\\"condom_use_value\\\":\\\"No\\\",\\\"severe_preeclampsia\\\":\\\"0\\\",\\\"occupation\\\":\\\"[informal_employment_sex_worker]\\\",\\\"isRelevant\\\":false,\\\"flu_immun_status\\\":\\\"seasonal_flu_dose_given\\\",\\\"lmp_edd\\\":\\\"0\\\",\\\"fetal_heartbeat_value\\\":\\\"Yes\\\",\\\"select_gest_age_edd\\\":\\\"sfh\\\",\\\"condom_use\\\":\\\"no\\\",\\\"medications\\\":\\\"[aspirin, calcium, asthma]\\\",\\\"blood_type_test_date_today_hidden\\\":\\\"27-09-2019\\\",\\\"danger_signs\\\":\\\"[danger_none]\\\",\\\"medications_value\\\":\\\"Aspirin, Calcium, Asthma\\\",\\\"height\\\":\\\"125\\\",\\\"tobacco_user_value\\\":\\\"No\\\",\\\"shs_exposure\\\":\\\"yes\\\",\\\"cant_record_bp_reason\\\":\\\"[bp_cuff_unavailable]\\\",\\\"preeclampsia\\\":\\\"0\\\",\\\"severe_hypertension\\\":\\\"0\\\",\\\"caffeine_counsel_value\\\":\\\"Done\\\",\\\"lmp_known_value\\\":\\\"No\\\",\\\"pulse_rate_repeat\\\":\\\"114\\\",\\\"toaster26_hidden\\\":\\\"0\\\",\\\"blood_type_test_date\\\":\\\"27-09-2019\\\",\\\"weight_gain\\\":\\\"0\\\",\\\"other_symptoms_value\\\":\\\"Gets tired easily, Headache, Vaginal discharge, Visual disturbance\\\",\\\"health_conditions_value\\\":\\\"Hypertension\\\",\\\"danger_signs_value\\\":\\\"None\\\",\\\"gest_age\\\":\\\"25\\\",\\\"ultrasound_ga_hidden\\\":\\\"0\\\",\\\"select_gest_age_edd_value\\\":\\\"Using SFH or abdominal palpation\\\",\\\"stillbirths\\\":\\\"1\\\",\\\"cant_record_bp_reason_value\\\":\\\"BP cuff (sphygmomanometer) not available\\\",\\\"health_conditions\\\":\\\"[hypertension]\\\",\\\"ultrasound_done_value\\\":\\\"No\\\",\\\"tobacco_user\\\":\\\"no\\\",\\\"exp_weight_gain\\\":\\\"5 - 9\\\",\\\"pulse_rate\\\":\\\"125\\\",\\\"tt_immun_status\\\":\\\"1-4_doses\\\",\\\"ipv_enquiry_results_value\\\":\\\"Treated\\\",\\\"weight_gain_duration\\\":\\\"0\\\",\\\"no_of_fetuses_unknown_value\\\":\\\"No. of fetuses unknown\\\",\\\"pallor_value\\\":\\\"Yes\\\",\\\"sfh_gest_age\\\":\\\"25\\\",\\\"caffeine_intake\\\":\\\"[more_than_3_cups_300ml_of_instant_coffee, more_than_48_pieces_squares_of_chocolate]\\\",\\\"flu_immun_status_value\\\":\\\"Seasonal flu dose given\\\",\\\"partner_hiv_status_value\\\":\\\"Dont know\\\",\\\"no_of_fetuses_unknown\\\":\\\"[no_of_fetuses_unknown]\\\",\\\"alcohol_substance_counsel\\\":\\\"done\\\",\\\"alcohol_substance_counsel_value\\\":\\\"Done\\\",\\\"phys_symptoms_value\\\":\\\"None\\\",\\\"pallor\\\":\\\"yes\\\",\\\"pelvic_exam\\\":\\\"2\\\",\\\"bmi\\\":\\\"35.84\\\",\\\"blood_type_test_status\\\":\\\"done_today\\\",\\\"ultrasound_edd\\\":\\\"0\\\",\\\"gest_age_openmrs\\\":\\\"25\\\",\\\"allergies_value\\\":\\\"Aluminium hydroxide\\\",\\\"gdm_risk\\\":\\\"1\\\",\\\"lmp_known_date\\\":\\\"\\\",\\\"hiv_risk\\\":\\\"1\\\",\\\"miscarriages_abortions\\\":\\\"2\\\",\\\"rh_factor\\\":\\\"positive\\\",\\\"ipv_enquiry_value\\\":\\\"Done\\\",\\\"helper\\\":null,\\\"ultrasound_done_date\\\":\\\"\\\",\\\"pelvic_exam_value\\\":\\\"Normal\\\",\\\"blood_type_test_status_value\\\":\\\"Done today\\\",\\\"alcohol_substance_enquiry_value\\\":\\\"Yes\\\",\\\"edd\\\":\\\"10-01-2020\\\",\\\"phys_symptoms\\\":\\\"[none]\\\",\\\"marital_status_value\\\":\\\"Never married and never lived together (single)\\\",\\\"respiratory_exam\\\":\\\"2\\\",\\\"weight_cat\\\":\\\"Obese\\\",\\\"hiv_positive\\\":\\\"0\\\",\\\"cant_record_bp_value\\\":\\\"Unable to record BP\\\",\\\"occupation_value\\\":\\\"Informal employment (sex worker)\\\",\\\"fetal_heartbeat\\\":\\\"yes\\\",\\\"shs_exposure_value\\\":\\\"Yes\\\",\\\"hepb_immun_status_value\\\":\\\"Not received\\\",\\\"ipv_enquiry\\\":\\\"done\\\",\\\"ipv_enquiry_results\\\":\\\"treated\\\",\\\"first_weight\\\":\\\"56\\\",\\\"sfh_edd\\\":\\\"10-01-2020\\\",\\\"tt_immun_status_value\\\":\\\"1-4 doses of TTCV in the past\\\",\\\"tot_weight_gain\\\":\\\"0\\\",\\\"current_weight\\\":\\\"56\\\",\\\"lmp_gest_age\\\":\\\"0\\\",\\\"lmp_known\\\":\\\"no\\\",\\\"allergies\\\":\\\"[aluminium_hydroxide]\\\",\\\"preeclampsia_risk\\\":\\\"1\\\",\\\"partner_hiv_positive\\\":\\\"0\\\",\\\"alcohol_substance_use\\\":\\\"[cocaine]\\\",\\\"alcohol_substance_use_value\\\":\\\"Cocaine \\\\\\/ Crack\\\",\\\"parity\\\":\\\"3\\\",\\\"c_sections\\\":\\\"1\\\",\\\"partner_hiv_status\\\":\\\"dont_know\\\",\\\"contact_reason\\\":\\\"scheduled_contact\\\",\\\"ultrasound_gest_age_concept\\\":\\\"0\\\",\\\"educ_level_value\\\":\\\"Higher\\\",\\\"rh_factor_value\\\":\\\"Positive\\\",\\\"ultrasound_done\\\":\\\"no\\\",\\\"educ_level\\\":\\\"higher\\\",\\\"blood_type\\\":\\\"a\\\",\\\"caffeine_counsel\\\":\\\"done\\\",\\\"other_symptoms\\\":\\\"[easily_tired, headache, vaginal_discharge, visual_disturbance]\\\",\\\"anaemic\\\":\\\"1\\\",\\\"sfh_ga_hidden\\\":\\\"25 weeks\\\",\\\"live_births\\\":\\\"2\\\",\\\"hepb_immun_status\\\":\\\"not_received\\\",\\\"contact_reason_value\\\":\\\"Scheduled contact\\\",\\\"ultrasound_gest_age\\\":\\\"0\\\",\\\"prev_preg_comps_value\\\":\\\"Gestational Diabetes\\\",\\\"caffeine_intake_value\\\":\\\"More than 3 cups (300 ml) of instant coffee, More than 48 pieces (squares) of chocolate\\\",\\\"fetal_heart_rate\\\":\\\"125\\\",\\\"pregest_weight_unknown_value\\\":\\\"Pre-gestational weight unknown\\\",\\\"marital_status\\\":\\\"single\\\",\\\"previous_pregnancies\\\":\\\"6\\\",\\\"alcohol_substance_enquiry\\\":\\\"yes\\\",\\\"blood_type_value\\\":\\\"A\\\",\\\"cant_record_bp\\\":\\\"[cant_record_bp]\\\",\\\"last_live_birth_preterm\\\":\\\"no\\\",\\\"hypertension\\\":\\\"0\\\",\\\"gravida\\\":\\\"7\\\",\\\"prev_preg_comps\\\":\\\"[gestational_diabetes]\\\",\\\"body_temp\\\":\\\"36\\\",\\\"respiratory_exam_value\\\":\\\"Normal\\\",\\\"last_live_birth_preterm_value\\\":\\\"No\\\"}\",\"ipv_enquiry_results\":\"treated\",\"ipv_enquiry\":\"done\",\"alcohol_substance_counsel\":\"done\",\"caffeine_counsel\":\"done\",\"invisible_required_fields_counselling_and_treatment\":\"[ipv_enquiry_notdone, referred_hosp_notdone, referred_hosp]\",\"rh_factor\":\"positive\",\"blood_type\":\"a\",\"blood_type_test_date\":\"27-09-2019\",\"blood_type_test_date_today_hidden\":\"27-09-2019\",\"blood_type_test_status\":\"done_today\",\"invisible_required_fields_tests\":\"[blood_type_test_date]\",\"preeclampsia_risk\":\"1\",\"no_of_fetuses_unknown\":\"[no_of_fetuses_unknown]\",\"fetal_heart_rate\":\"125\",\"fetal_heartbeat\":\"yes\",\"toaster26_hidden\":\"0\",\"pelvic_exam\":\"2\",\"respiratory_exam\":\"2\",\"anaemic\":\"1\",\"pallor\":\"yes\",\"pulse_rate_repeat\":\"114\",\"pulse_rate\":\"125\",\"body_temp\":\"36\",\"preeclampsia\":\"0\",\"severe_preeclampsia\":\"0\",\"severe_hypertension\":\"0\",\"hypertension\":\"0\",\"cant_record_bp_reason\":\"[bp_cuff_unavailable]\",\"cant_record_bp\":\"[cant_record_bp]\",\"tot_weight_gain\":\"0\",\"weight_gain\":\"0\",\"weight_gain_duration\":\"0\",\"exp_weight_gain\":\"5 - 9\",\"weight_cat\":\"Obese\",\"gdm_risk\":\"1\",\"bmi\":\"35.84\",\"first_weight\":\"56\",\"current_weight\":\"56\",\"pregest_weight_unknown\":\"[pregest_weight_unknown]\",\"height\":\"125\",\"invisible_required_fields_physical_exam\":\"[fetal_presentation, symp_sev_preeclampsia, pregest_weight_label, pregest_weight, body_temp_repeat_label, bp_diastolic_repeat, bp_systolic, fetal_heart_rate_repeat, bp_systolic_repeat_label, bp_diastolic, bp_systolic_repeat, urine_protein, bp_diastolic_label, bp_diastolic_repeat_label, bp_systolic_label, body_temp_repeat, fetal_heart_rate_repeat_label]\",\"other_symptoms\":\"[easily_tired, headache, vaginal_discharge, visual_disturbance]\",\"phys_symptoms\":\"[none]\",\"invisible_required_fields_symptoms_and_follow-up\":\"[phys_symptoms_persist, other_sym_lbpp, behaviour_persist, other_sym_vvo, medications, mat_percept_fetal_move]\",\"hiv_risk\":\"1\",\"partner_hiv_positive\":\"0\",\"partner_hiv_status\":\"dont_know\",\"alcohol_substance_use\":\"[cocaine]\",\"alcohol_substance_enquiry\":\"yes\",\"condom_use\":\"no\",\"shs_exposure\":\"yes\",\"tobacco_user\":\"no\",\"caffeine_intake\":\"[more_than_3_cups_300ml_of_instant_coffee, more_than_48_pieces_squares_of_chocolate]\",\"medications\":\"[aspirin, calcium, asthma]\",\"flu_immun_status\":\"seasonal_flu_dose_given\",\"hepb_immun_status\":\"not_received\",\"tt_immun_status\":\"1-4_doses\",\"hiv_positive\":\"0\",\"health_conditions\":\"[hypertension]\",\"allergies\":\"[aluminium_hydroxide]\",\"prev_preg_comps\":\"[gestational_diabetes]\",\"c_sections\":\"1\",\"parity\":\"3\",\"stillbirths\":\"1\",\"last_live_birth_preterm\":\"no\",\"live_births\":\"2\",\"miscarriages_abortions\":\"2\",\"previous_pregnancies\":\"6\",\"gravida\":\"7\",\"edd\":\"10-01-2020\",\"gest_age_openmrs\":\"25\",\"gest_age\":\"25\",\"select_gest_age_edd\":\"sfh\",\"sfh_ga_hidden\":\"25 weeks\",\"sfh_edd\":\"10-01-2020\",\"sfh_gest_age\":\"25\",\"ultrasound_gest_age\":\"0\",\"ultrasound_ga_hidden\":\"0\",\"ultrasound_edd\":\"0\",\"ultrasound_gest_age_concept\":\"0\",\"ultrasound_done\":\"no\",\"lmp_gest_age\":\"0\",\"lmp_edd\":\"0\",\"lmp_known\":\"no\",\"occupation\":\"[informal_employment_sex_worker]\",\"marital_status\":\"single\",\"educ_level\":\"higher\",\"invisible_required_fields_profile\":\"[ultrasound_gest_age_wks, hiv_diagnosis_date]\",\"danger_signs\":\"[danger_none]\",\"contact_reason\":\"scheduled_contact\",\"invisible_required_fields_quick_check\":\"[specific_complaint]\",\"contact_schedule\":\"[31, 35, 37, 39, 40, 41]\"}");
        details.put("open_test_tasks", "[\"{\\\"key\\\":\\\"accordion_tb_screening\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\",\\\"text\\\":\\\"TB Screening\\\",\\\"accordion_info_text\\\":\\\"In settings where the tuberculosis (TB) prevalence in the general population is 100\\\\\\/100,000 persons or higher or in settings with sub-populations that have very poor access to health care, or if the woman is HIV positive, TB screening is recommended.\\\",\\\"accordion_info_title\\\":\\\"TB screening\\\",\\\"type\\\":\\\"expansion_panel\\\",\\\"content_form\\\":\\\"tests_tb_screening_sub_form\\\",\\\"container\\\":\\\"anc_test\\\",\\\"relevance\\\":{\\\"rules-engine\\\":{\\\"ex-rules\\\":{\\\"rules-file\\\":\\\"tests_expansion_panel_relevance_rules.yml\\\"}}},\\\"is_visible\\\":true,\\\"value\\\":[{\\\"key\\\":\\\"tb_screening_status\\\",\\\"type\\\":\\\"extended_radio_button\\\",\\\"label\\\":\\\"TB screening\\\",\\\"index\\\":0,\\\"values\\\":[\\\"not_done:Not done\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"1118AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},\\\"value_openmrs_attributes\\\":[{\\\"key\\\":\\\"tb_screening_status\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"1118AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}]},{\\\"key\\\":\\\"tb_screening_notdone\\\",\\\"type\\\":\\\"check_box\\\",\\\"label\\\":\\\"Reason\\\",\\\"index\\\":2,\\\"values\\\":[\\\"sputum_culture:Sputum culture not available:true\\\",\\\"xray_machine:X-ray machine not available:true\\\",\\\"machine_not_functioning:Machine not functioning:true\\\",\\\"technician_not_available:Technician not available:true\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"164800AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165182AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},\\\"value_openmrs_attributes\\\":[{\\\"key\\\":\\\"tb_screening_notdone\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165402AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},{\\\"key\\\":\\\"tb_screening_notdone\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165404AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},{\\\"key\\\":\\\"tb_screening_notdone\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165179AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},{\\\"key\\\":\\\"tb_screening_notdone\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165400AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}]},{\\\"key\\\":\\\"tb_screening_date_today_hidden\\\",\\\"type\\\":\\\"hidden\\\",\\\"label\\\":\\\"\\\",\\\"index\\\":4,\\\"values\\\":[\\\"0\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\"}}],\\\"required_fields\\\":[\\\"tb_screening_status\\\",\\\"tb_screening_notdone\\\"]}\",\"{\\\"key\\\":\\\"accordion_blood_haemoglobin\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\",\\\"text\\\":\\\"Blood Haemoglobin test\\\",\\\"accordion_info_text\\\":\\\"Blood haemoglobin testing is necessary for diagnosing anaemia in pregnancy.\\\",\\\"accordion_info_title\\\":\\\"Blood haemoglobin test\\\",\\\"type\\\":\\\"expansion_panel\\\",\\\"content_form\\\":\\\"tests_blood_haemoglobin_sub_form\\\",\\\"container\\\":\\\"anc_test\\\",\\\"relevance\\\":{\\\"rules-engine\\\":{\\\"ex-rules\\\":{\\\"rules-file\\\":\\\"tests_expansion_panel_relevance_rules.yml\\\"}}},\\\"is_visible\\\":true}\",\"{\\\"key\\\":\\\"accordion_urine\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\",\\\"text\\\":\\\"Urine test\\\",\\\"accordion_info_text\\\":\\\"A urine test is required at the first contact, last contact in 2nd trimester, and 2nd contact in 3rd trimester OR anytime the woman reports pain during urination (dysuria). A dipstick test is required if the woman has a repeat high BP reading (140\\\\\\/90 or higher). Otherwise, a urine test is optional. The urine test checks for bacterial or other infections that can lead to adverse outcomes for the neonate. The urine dipstick test can check for proteins in the urine, which can be a sign of pre-eclampsia.\\\",\\\"accordion_info_title\\\":\\\"Urine test\\\",\\\"type\\\":\\\"expansion_panel\\\",\\\"content_form\\\":\\\"tests_urine_sub_form\\\",\\\"container\\\":\\\"anc_test\\\",\\\"relevance\\\":{\\\"rules-engine\\\":{\\\"ex-rules\\\":{\\\"rules-file\\\":\\\"tests_expansion_panel_relevance_rules.yml\\\"}}},\\\"is_visible\\\":true,\\\"value\\\":[{\\\"key\\\":\\\"urine_test_status\\\",\\\"type\\\":\\\"extended_radio_button\\\",\\\"label\\\":\\\"Urine test\\\",\\\"index\\\":0,\\\"values\\\":[\\\"ordered:Ordered\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},\\\"value_openmrs_attributes\\\":[{\\\"key\\\":\\\"urine_test_status\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}]},{\\\"key\\\":\\\"urine_test_date_today_hidden\\\",\\\"type\\\":\\\"hidden\\\",\\\"label\\\":\\\"\\\",\\\"index\\\":4,\\\"values\\\":[\\\"0\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\"}},{\\\"key\\\":\\\"urine_test_type\\\",\\\"type\\\":\\\"check_box\\\",\\\"label\\\":\\\"Urine test type\\\",\\\"index\\\":6,\\\"values\\\":[\\\"midstream_urine_culture:Midstream urine culture (recommended):true\\\",\\\"midstream_urine_gram:Midstream urine Gram-staining:true\\\",\\\"urine_dipstick:Urine dipstick:true\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165438AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},\\\"value_openmrs_attributes\\\":[{\\\"key\\\":\\\"urine_test_type\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165392AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},{\\\"key\\\":\\\"urine_test_type\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165304AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},{\\\"key\\\":\\\"urine_test_type\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"1618AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}]},{\\\"key\\\":\\\"gdm_risk\\\",\\\"type\\\":\\\"hidden\\\",\\\"label\\\":\\\"\\\",\\\"index\\\":13,\\\"values\\\":[\\\"0\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165261AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}},{\\\"key\\\":\\\"asb_positive\\\",\\\"type\\\":\\\"hidden\\\",\\\"label\\\":\\\"\\\",\\\"index\\\":15,\\\"values\\\":[\\\"0\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"121358AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}}],\\\"required_fields\\\":[\\\"urine_test_status\\\",\\\"urine_test_type\\\"]}\",\"{\\\"key\\\":\\\"accordion_syphilis\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\",\\\"text\\\":\\\"Syphilis test\\\",\\\"accordion_info_text\\\":\\\"A syphilis test is recommended for all pregnant women at the first contact and again at the first contact of 3rd trimester (28 weeks). Women who are already confirmed positive for syphilis do not need to be tested.\\\",\\\"accordion_info_title\\\":\\\"Syphilis test\\\",\\\"type\\\":\\\"expansion_panel\\\",\\\"content_form\\\":\\\"tests_syphilis_sub_form\\\",\\\"container\\\":\\\"anc_test\\\",\\\"relevance\\\":{\\\"rules-engine\\\":{\\\"ex-rules\\\":{\\\"rules-file\\\":\\\"tests_expansion_panel_relevance_rules.yml\\\"}}},\\\"is_visible\\\":true}\",\"{\\\"key\\\":\\\"accordion_hepatitis_b\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\",\\\"text\\\":\\\"Hepatitis B test\\\",\\\"accordion_info_text\\\":\\\"In settings where the proportion of HBsAg seroprevalence in the general population is 2% or higher or in settings where there is a national Hep B ANC routine screening program in place, or if the woman is HIV positive, injects drugs, or is a sex worker, then Hep B testing is recommended if the woman is not fully vaccinated against Hep B.\\\",\\\"accordion_info_title\\\":\\\"Hepatitis B test\\\",\\\"type\\\":\\\"expansion_panel\\\",\\\"content_form\\\":\\\"tests_hepatitis_b_sub_form\\\",\\\"container\\\":\\\"anc_test\\\",\\\"relevance\\\":{\\\"rules-engine\\\":{\\\"ex-rules\\\":{\\\"rules-file\\\":\\\"tests_expansion_panel_relevance_rules.yml\\\"}}},\\\"is_visible\\\":true,\\\"value\\\":[{\\\"key\\\":\\\"hepb_test_status\\\",\\\"type\\\":\\\"extended_radio_button\\\",\\\"label\\\":\\\"Hepatitis B test\\\",\\\"index\\\":0,\\\"values\\\":[\\\"not_done:Not done\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"1118AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},\\\"value_openmrs_attributes\\\":[{\\\"key\\\":\\\"hepb_test_status\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"1118AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}]},{\\\"key\\\":\\\"hepb_test_notdone\\\",\\\"type\\\":\\\"check_box\\\",\\\"label\\\":\\\"Reason\\\",\\\"index\\\":2,\\\"values\\\":[\\\"stock_out:Stock out:true\\\",\\\"expired_stock:Expired stock:true\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"161475AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165182AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},\\\"value_openmrs_attributes\\\":[{\\\"key\\\":\\\"hepb_test_notdone\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165183AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},{\\\"key\\\":\\\"hepb_test_notdone\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165299AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}]},{\\\"key\\\":\\\"hepb_test_date_today_hidden\\\",\\\"type\\\":\\\"hidden\\\",\\\"label\\\":\\\"\\\",\\\"index\\\":4,\\\"values\\\":[\\\"0\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\"}},{\\\"key\\\":\\\"hepb_positive\\\",\\\"type\\\":\\\"hidden\\\",\\\"label\\\":\\\"\\\",\\\"index\\\":10,\\\"values\\\":[\\\"0\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"111759AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}}],\\\"required_fields\\\":[\\\"hepb_test_status\\\",\\\"hepb_test_notdone\\\"]}\",\"{\\\"key\\\":\\\"accordion_blood_type\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\",\\\"text\\\":\\\"Blood Type test\\\",\\\"type\\\":\\\"expansion_panel\\\",\\\"content_form\\\":\\\"tests_blood_type_sub_form\\\",\\\"container\\\":\\\"anc_test\\\",\\\"relevance\\\":{\\\"rules-engine\\\":{\\\"ex-rules\\\":{\\\"rules-file\\\":\\\"tests_expansion_panel_relevance_rules.yml\\\"}}},\\\"is_visible\\\":true,\\\"value\\\":[{\\\"key\\\":\\\"blood_type_test_status\\\",\\\"type\\\":\\\"extended_radio_button\\\",\\\"label\\\":\\\"Blood type test\\\",\\\"index\\\":0,\\\"values\\\":[\\\"ordered:Ordered\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"},\\\"value_openmrs_attributes\\\":[{\\\"key\\\":\\\"blood_type_test_status\\\",\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"concept\\\",\\\"openmrs_entity_id\\\":\\\"165384AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}]},{\\\"key\\\":\\\"blood_type_test_date_today_hidden\\\",\\\"type\\\":\\\"hidden\\\",\\\"label\\\":\\\"\\\",\\\"index\\\":2,\\\"values\\\":[\\\"0\\\"],\\\"openmrs_attributes\\\":{\\\"openmrs_entity_parent\\\":\\\"\\\",\\\"openmrs_entity\\\":\\\"\\\",\\\"openmrs_entity_id\\\":\\\"\\\"}}],\\\"required_fields\\\":[\\\"blood_type_test_status\\\"]}\"]");
        return details;
    }

    @NotNull
    private Event getEvent(Map<String, String> details) {
        Event event = new Event();
        event.setBaseEntityId("test-base-entity-id");
        event.setEventType("Contact Visit");
        event.setEntityType("ec_woman");
        event.setDetails(details);
        return event;
    }

    @NotNull
    private Client getClient() {
        return new Client("test-base-entity-id", "Ben", "simon", "tenx", new DateTime("2009-12-11T00:00:00.000Z"), null, true, false, "M");
    }
}